<style>
    th{background-color: #dddddd}
</style>
<!DOCTYPE html>
<html>
<head>
<title>Check list part 3</title>
<script src="https://unpkg.com/pdf-lib@1.4.0"></script> 
<script src="https://unpkg.com/downloadjs@1.4.7"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"
integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
crossorigin="anonymous"></script>
<!-- From https://codepen.io/hudson-moreira/pen/MWmpqPb  -->
<script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.8/purify.min.js"></script>
</head>

<body id="pdf-body">
<h1>Check list part 3</h1>
<form>
    <input type="checkbox" id="startcontroller" value="Yes" />
    <label for="fname" data-phrase-id="startcontroller">Start controller</label><br />
    
    <input type="checkbox" id="startuav" value="Yes" />
    <label for="fname" data-phrase-id="startuav">Start UAV</label><br />
    
    <input type="checkbox" id="startrecording" value="Yes" />
    <label for="fname" data-phrase-id="startrecording">Start recording</label><br />

    <input type="checkbox" id="hover20sec" value="Yes" />
    <label for="fname" data-phrase-id="hover20sec">Hover for 20 sec</label><br />
    
    <input type="checkbox" id="hoveraccomplished" value="Yes" />
    <label for="fname" data-phrase-id="hoveraccomplished">Hover accomplished</label><br />
    
    <input type="checkbox" id="hovernoise" value="Yes" />
    <label for="fname" data-phrase-id="hovernoise">Hover noise?</label><br />

    <input type="checkbox"  id="hoverpropeller" value="Yes" />
    <label for="fname" data-phrase-id="hoverpropeller">Hover propeller noise?</label><br />

    <br />
    <label for="fname" data-phrase-id="starttime">Start time</label>
    <input type="time" id="starttime" /><br />

    <label for="fname" data-phrase-id="endtime">End time</label>
    <input type="time" id="endtime" /><br />

    <label for="fname" data-phrase-id="numberpictures">Number of pictures</label>
    <input type="number" id="numberpictures" /><br /><br />

    <h3 data-phrase-id="landing">Checklist after landing</h3>

<table style="width:100%">
    <tr>
        <th data-phrase-id="whattodo" >What to do</th>
        <th>OK</th>
        <th data-phrase-id="replaced" >Replaced</th>
        <th data-phrase-id="date" >Date</th>
        <th data-phrase-id="checkedby" >Checked by</th>
    </tr>
    <tr>
        <td data-phrase-id="aftercheckbody">The propellers, motors, and aircraft body are intact, and there is no sign for collision or loose or broken structures.</td>
        <td><input type="radio" name="aftercheckbodyR" value="Yes"/>
            <label data-phrase-id="yes">Yes</label>
            <input type="radio" name="aftercheckbodyR" value="No"/>
            <label data-phrase-id="no">No</label>
        </td>
        <td><input type="checkbox" id="aftercheckbodyC" value="Yes" /></td>
        <td><input type="date" id="aftercheckbodyD" /></td>
        <td><input type="text" id="aftercheckbodyT" /></td>
    </tr>
    <tr>
        <td><label data-phrase-id="afterchecktemp">The temperature of the motors is normal and there are no signs of uneven heating.</label></td>
        <td> <input type="radio" name="afterchecktempR" value="Yes" />
            <label data-phrase-id="yes">Yes</label>
            <input type="radio" name="afterchecktempR" value="No"/>
            <label data-phrase-id="no">No</label><br />
        </td>
        <td><input type="checkbox" id="afterchecktempC" value="Yes" /></td>
        <td><input type="date" id="afterchecktempD" /></td>
        <td><input type="text" id="afterchecktempT" /></td>
    </tr>
</table>

<h3 data-phrase-id="pilotreport">Pilot report</h3> 

<table style="width:100%">
    <tr>
        <th>3</th>
        <th>Anything to report</th>
        <th>Pilot report</th>
        <th>Minor</th>
        <th>Unacceptable</th>
        <th>Link TX/RX</th>
        <th>Other</th>
    </tr>
    <tr>
        <td>Deficiency</td>
        <td><input type="radio" name="deficiency0" value="Yes"/>
            <label data-phrase-id="yes">Yes</label>
            <input type="radio" name="deficiency0" value="Nothing to report."/>
            <label data-phrase-id="no">No</label>
        </td>
        <td><textarea id="deficiency1" rows="10" cols="50" maxlength="500" style="resize: none ;"></textarea></td>
        <td><input type="text" id="deficiency2" /></td>
        <td><input type="text" id="deficiency3" /></td>
        <td><input type="text" id="deficiency4" /></td>
        <td><input type="text" id="deficiency5" /></td>
    </tr>
    <tr>
        <td>Damage</td>
        <td><input type="radio" name="damage0" value="Yes"/>
            <label data-phrase-id="yes">Yes</label>
            <input type="radio" name="damage0" value="Nothing to report."/>
            <label data-phrase-id="no">No</label>
        </td>
        <td><textarea id="damage1" rows="10" cols="50" maxlength="500" style="resize: none ;"></textarea></td>
        <td><input type="text" id="damage2" /></td>
        <td><input type="text" id="damage3" /></td>
        <td><input type="text" id="damage4" /></td>
        <td><input type="text" id="damage5" /></td>
    </tr>
    <tr>
        <td>Interference</td>
        <td><input type="radio" name="interference0" value="Yes"/>
            <label data-phrase-id="yes">Yes</label>
            <input type="radio" name="interference0" value="Nothing to report."/>
            <label data-phrase-id="no">No</label>
        </td>
        <td><textarea id="interference1" rows="10" cols="50" maxlength="500" style="resize: none ;"></textarea></td>
        <td><input type="text" id="interference2" /></td>
        <td><input type="text" id="interference3" /></td>
        <td><input type="text" id="interference4" /></td>
        <td><input type="text" id="interference5" /></td>
    </tr>
    <tr>
        <td>Other</td>
        <td><input type="radio" name="other0" value="Yes"/>
            <label data-phrase-id="yes">Yes</label>
            <input type="radio" name="other0" value="Nothing to report."/>
            <label data-phrase-id="no">No</label>
        </td>
        <td><textarea id="other1" rows="10" cols="50" maxlength="500" style="resize: none ;"></textarea></td>
        <td><input type="text" id="other2" /></td>
        <td><input type="text" id="other3" /></td>
        <td><input type="text" id="other4" /></td>
        <td><input type="text" id="other5" /></td>
    </tr>
</table>
</form>

    <br />
    <button type="submit" class="btn btn-primary" onclick="saveFile()" data-phrase-id="savepdf">Save check list part 3</button><br /><br />

    <p>  Add file for check list part 1<br />
        and then<br />
        add file for check list part 2<br />
        and then<br />
        add file for check list part 3<br />
    </p>

    <div class="list-files">
        <div class="no-files">No files added</div>
    </div>

    <div style="display:none">
    <input type="file" id="pdf-file" accept="application/pdf" /></div><br />
    <button class="btn-join" onclick="$('#pdf-file').click()">ADD PDF</button><br /><br />
    <button class="btn-join" onclick="joinPdf()">Create checklist</button><br /><br />

    <a href="/check1.html">Part 1</a><br />
    <a href="/check2.html">Part 2</a><br />
    <a href="/check3.html">Part 3</a><br />

<script>
      const { PDFDocument } = PDFLib
      const { jsPDF } = jspdf
      
// Check the clicked radio button in a group, and return the value. If no button was clicked an empty value is returned.
function getCheckedValue(el) {
  for (var i = 0, length = el.length; i < length; i++) {
    if (el[i].checked) {
      return el[i].value;
      break;
    }
  }
  return '';
}

 //  Save the info the users have entered into a pdf-file
   
function saveFile(){
    // Get the data from each element in the form.
    var readytosave = true;     
    const startcontroller = document.getElementById('startcontroller');
    const startuav = document.getElementById('startuav');
    const startrecording = document.getElementById('startrecording');
    const hover20sec = document.getElementById('hover20sec');
    const hoveraccomplished = document.getElementById('hoveraccomplished');
    const hovernoise = document.getElementById('hovernoise');
    const hoverpropeller = document.getElementById('hoverpropeller');
    const starttime = document.getElementById('starttime');
    const endtime = document.getElementById('endtime');
    const numberpictures = document.getElementById('numberpictures');

    const aftercheckbodyR = getCheckedValue(document.getElementsByName('aftercheckbodyR'));
    const aftercheckbodyC = checkcheckbox(document.getElementById('aftercheckbodyC'));
    const aftercheckbodyD = document.getElementById('aftercheckbodyD');
    const aftercheckbodyT = document.getElementById('aftercheckbodyT');

    const afterchecktempR = getCheckedValue(document.getElementsByName('afterchecktempR'));
    const afterchecktempC = checkcheckbox(document.getElementById('afterchecktempC'));
    const afterchecktempD = document.getElementById('afterchecktempD');
    const afterchecktempT = document.getElementById('afterchecktempT');

    const deficiency0 = getCheckedValue(document.getElementsByName('deficiency0'));
    const deficiency1 = document.getElementById('deficiency1');
    const deficiency2 = document.getElementById('deficiency2');
    const deficiency3 = document.getElementById('deficiency3');
    const deficiency4 = document.getElementById('deficiency4');
    const deficiency5 = document.getElementById('deficiency5');

    const damage0 = getCheckedValue(document.getElementsByName('damage0'));
    const damage1 = document.getElementById('damage1');
    const damage2 = document.getElementById('damage2');
    const damage3 = document.getElementById('damage3');
    const damage4 = document.getElementById('damage4');
    const damage5 = document.getElementById('damage5');

    const interference0 = getCheckedValue(document.getElementsByName('interference0'));
    const interference1 = document.getElementById('interference1');
    const interference2 = document.getElementById('interference2');
    const interference3 = document.getElementById('interference3');
    const interference4 = document.getElementById('interference4');
    const interference5 = document.getElementById('interference5');

    const other0 = getCheckedValue(document.getElementsByName('other0'));
    const other1 = document.getElementById('other1');
    const other2 = document.getElementById('other2');
    const other3 = document.getElementById('other3');
    const other4 = document.getElementById('other4');
    const other5 = document.getElementById('other5');

    // Checking if the checbox is clicked or not. Returning the value of the checkbox if it is checked.
    function checkcheckbox(element){
    if(element.checked){
        return element.value;
    }
    else return '';
    }

     // Don't download the file if any fields have been left blank 
     if (
        !starttime.value ||
        !endtime.value ||
        !numberpictures.value ||
        
        //radiobuttons ||
        !aftercheckbodyR ||
        !afterchecktempR ||
        !deficiency0 ||
        !damage0 ||
        !interference0 ||
        !other0
    ){  
        readytosave = false;
        alert("All controls must have been done before saving."); 
    }

     // Don't download the file if any checkbox have been left unchecked
     if (
        startcontroller.checked === false ||
        startuav.checked === false ||
        startrecording.checked === false ||
        hover20sec.checked === false ||
        hoveraccomplished.checked === false ||
        hovernoise.checked === false ||
        hoverpropeller.checked === false 
    ){
        readytosave = false;
        alert("All checks must have been done before saving.");
    }

    if (readytosave === false) { return }
       
    // This variable stores all the data as it will be presented in the file
    let data = 
        '<h1>Check List part 3</h1>' + 
        'Start controller: ' + startcontroller.value + ' <br /> ' + 
        'Start UAV: ' + startuav.value + ' <br />' + 
        'Start recording: ' + startrecording.value + ' <br />' + 
        'Hover for 20 sec - box?: ' + hover20sec.value + '<br />' +
        'Hover accomplished: ' + hoveraccomplished.value + ' <br />' + 
        'Hover noise?: ' + hovernoise.value + '<br /> ' + 
        'Hover propeller noise?: ' + hoverpropeller.value + '<br />' + 
        'Start time: ' + starttime.value + '<br />' + 
        'End time: ' + endtime.value + ' <br /> ' + 
        'Number of pictures: ' + numberpictures.value + ' <br /> ' +

        '<h2>Checklist after landing</h2> ' +
        '<br />The propellers, motors and aircraft body are intact and there is no (visible?) sign for collision or  loose or broken structures. <br />' + aftercheckbodyR + '<br /> ' +
        'Replaced: ' + aftercheckbodyC + '<br />' +
        'Date: ' + aftercheckbodyD.value + ' <br /> ' +
        'Checked by : ' + aftercheckbodyT.value + '<br /> ' +

        '<br />The temperature of the motors is normal and there are no signs of uneven heating.<br /> ' + afterchecktempR + '<br />' +
        'Replaced: ' + afterchecktempC + '<br />' +
        'Date: ' + afterchecktempD.value + ' <br />' +
        'Checked by : ' + afterchecktempT.value + ' <br /> ' +

        '<h2>Pilot report</h2> ' +
        
        '<b>Deficiency </b>' + deficiency0 + '<br /><br />  ' +
        'Pilot report: ' + deficiency1.value + '<br /><br /> ' +
        'Minor deficiency: ' + deficiency2.value + '<br /><br />' +
        'Unacceptable deficiency: ' + deficiency3.value + '<br /><br /> ' +
        'Link TX/RX: ' + deficiency4.value + '<br /><br /> ' +
        'Other: ' + deficiency5.value + '<br /> ' +

        '<br /><b>Damage </b>' + damage0 + '<br /><br />  ' +
        'Pilot report: ' + damage1.value + '<br /><br /> ' +
        'Minor deficiency: ' + damage2.value + '<br /><br /> ' +
        'Unacceptable deficiency: ' + damage3.value + '<br /><br /> ' +
        'Link TX/RX: ' + damage4.value + '<br /><br />' +
        'Other: ' + damage5.value + '<br /> ' +

        '<br /><b>Interference </b>' + interference0 + '<br /><br />  ' +
        'Pilot report: ' + interference1.value + '<br /><br />' +
        'Minor deficiency: ' + interference2.value + '<br /><br /> ' +
        'Unacceptable deficiency: ' + interference3.value + '<br /><br /> ' +
        'Link TX/RX: ' + interference4.value + '<br /><br /> ' +
        'Other: ' + interference5.value + '<br /> '+

        '<br /><b>Other </b>' + other0 + '<br /><br />  ' +
        'Pilot report: ' + other1.value + '<br /><br /> ' +
        'Minor deficiency: ' + other2.value + '<br /><br /> ' +
        'Unacceptable deficiency: ' + other3.value + '<br /><br /> ' +
        'Link TX/RX: ' + other4.value + '<br /><br /> ' +
        'Other: ' + other5.value + '<br />';

    //Construct the filename with todays date
    var month =new Date(); //months from 1-12
    month = month.getMonth()+1;
    var day = new Date();
    day = day.getUTCDate();
    var year = new Date();
    year = year.getUTCFullYear();
    newdate = year + "_" + month + "_" + day;
    const sFileName = newdate + '_part3.pdf'; // The file to save the data.

    // The format of the file
    const pageFormat = 'a4';
    const pageOrient = 'p';
    let pdfOptions = {
    compress:true,
    format:pageFormat,
    hotfixes:['px_scaling'],
    orientation:pageOrient,
    unit:'px'
    };

    const { PDFDocument } = PDFLib;
    window.html2canvas = html2canvas;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF(pdfOptions);

    const pageMarginX = 60;
    const pageMarginY = 90;
    const pageWidth   = doc.internal.pageSize.width - (pageMarginX * 2);

    // bug: if document created from HTML is > 1 page, adobe reader reports page errors starting with page 2
    // fix: manually add pages that would exist if HTML is rendered (must be added before rendering the HTML!)
    // ugly soluton: render document once, count pages, render again with the required pages added beforehand
    new jsPDF(pdfOptions).html(data,{
    autoPaging:'text',
    margin:[pageMarginY,pageMarginX,pageMarginY,pageMarginX],
    width:pageWidth,
    windowWidth:pageWidth,
    callback:res => {
        // add pages that are required by the rendered HTML (start with page 2)
        for(let i = 2, j = res.internal.getNumberOfPages(); i <= j; i++) {
        doc.addPage(pageFormat,pageOrient);
        }

        // render document proper
        doc.html(data,{
        autoPaging:'text',
        margin:[pageMarginY,pageMarginX,pageMarginY,pageMarginX],
        width:pageWidth,
        windowWidth:pageWidth,
        callback:function() {
            doc.save(sFileName);
        }
        });
    }
    });
}

    window.arrayOfPdf = []
    var input = document.getElementById("pdf-file")

    function openfile(evt) {
        var files = input.files;
        fileData = new Blob([files[0]]);
        // Pass getBuffer to promise.
        var promise = new Promise(getBuffer(fileData));
        promise.then(function(data) {
            window.arrayOfPdf.push({
                bytes: data,
                name: files[0].name
            })
            listFilesOnScreen()
        }).catch(function(err) {
            console.log('Error: ', err);
        });
    }

    function getBuffer(fileData) {
        return function(resolve) {
            var reader = new FileReader();
            reader.readAsArrayBuffer(fileData);
            reader.onload = function() {
                var arrayBuffer = reader.result
                var bytes = new Uint8Array(arrayBuffer);
                resolve(bytes);
            }
        }
    }

    function listFilesOnScreen() {
        $('.pdf-file').remove()
        if (window.arrayOfPdf.length > 0) {
            $('.no-files').hide()
            $.each(window.arrayOfPdf, function(i, v) {
                $('.list-files').append(` 
            <div id="pdf-${i}" class="pdf-file">
            <div onclick="removePdf(${i})" class="btn-remove">x</div>
            <img style="height: 75px" src="pdf.png">
            <br>
            ${v.name}</div>`)
            })
        } else { $('.no-files').show() }
    }

    function removePdf(index) {
        window.arrayOfPdf.splice(index, 1);
        listFilesOnScreen()
    }

    async function joinPdf() {
        const mergedPdf = await PDFDocument.create();
        for (let document of window.arrayOfPdf) {
            document = await PDFDocument.load(document.bytes);
            const copiedPages = await mergedPdf.copyPages(document, document.getPageIndices());
            copiedPages.forEach((page) => mergedPdf.addPage(page));
        }
        var pdfBytes = await mergedPdf.save();
        download(pdfBytes, "checklist_" + new Date() + ".pdf", "application/pdf");
    }

    input.addEventListener('change', openfile, false);

    function mostrarDados() {}

</script>
</body>
</html>